#!/usr/bin/env python

import os
import sys
from os import path
import subprocess

def mkdir_safe(path):
	try: 
		os.makedirs(path)
	except OSError:
		if not os.path.isdir(path):
			raise

def call(args):
	print(" ".join(args))
	return_code = subprocess.call(args)	
	if return_code != 0:
		print("Exited with return code: " + str(return_code))
		sys.exit(return_code)

def go(temp_dir, install_dir):
	os.chdir(os.environ["GET_IMAGE_BUILD_ROOT"])
	mkdir_safe(temp_dir)
	os.chdir(temp_dir)
	call(["cmake", "-G", os.environ["GET_IMAGE_CMAKE_GENERATOR"], os.environ["GET_IMAGE_SOURCE_ROOT"], "-DCMAKE_BUILD_TYPE="+os.environ["GET_IMAGE_CMAKE_CONFIG"]])
	call(["cmake", "--build", path.curdir, "--config", os.environ["GET_IMAGE_CMAKE_CONFIG"]])
	call(["cmake", "-DCMAKE_INSTALL_PREFIX=" + path.join(os.pardir, install_dir), "-P", "cmake_install.cmake"])

if __name__ == "__main__":
	go("temp", "install")


